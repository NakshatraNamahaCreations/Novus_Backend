generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PrescriptionFileType {
  IMAGE
  PDF
}

enum Alignment {
  LEFT
  RIGHT
  CENTER
}

enum TestResultStatus {
  DRAFT
  REPORTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum PrescriptionStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

// ⭐ NEW: Payment enums
enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
  COMPLETED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  NET_BANKING
  WALLET
  CHEQUE
  BANK_TRANSFER
}

enum PaymentMode {
  ONLINE
  OFFLINE
}

model Pincode {
  id      Int     @id @default(autoincrement())
  pincode String  @unique
  city    String?
  state   String?
  area    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id     Int    @id @default(autoincrement())
  imgUrl String

  testId Int?
  test   Test? @relation(fields: [testId], references: [id], onDelete: SetNull)

  packageId Int?
  package   HealthPackage? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testId])
  @@index([packageId])
  @@index([createdById])
}

enum SpotlightShowIn {
  HOME_MIDDLE
  HOME_END
  TEST_PAGE
  CHECKUP_PAGE
}

model SpotlightBanner {
  id     Int    @id @default(autoincrement())
  imgUrl String

  showIn SpotlightShowIn[]

  testId Int?
  test   Test? @relation(fields: [testId], references: [id], onDelete: SetNull)

  packageId Int?
  package   HealthPackage? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testId])
  @@index([packageId])
  @@index([createdById])
  @@index([showIn])
}

model CollectionPrice {
  id Int @id @default(autoincrement())

  // Scope (you can use one or more)
  centerId Int?
  cityId   Int?
  pincode  String?

  price Float
  minAmount      Float @default(299)
  isActive Boolean @default(true)

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  center Center? @relation(fields: [centerId], references: [id])
  city   City?   @relation(fields: [cityId], references: [id])

  @@index([centerId])
  @@index([cityId])
  @@index([pincode])
}

model City {
  id   Int    @id @default(autoincrement())
  name String @unique

  diagnosticCenters DiagnosticCenter[]
  centers           Center[]
  collectionPrices  CollectionPrice[]
}

model Sources {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model DiagnosticCenter {
  id      Int     @id @default(autoincrement())
  name    String
  address String?
  pincode String?

  cityId Int
  city   City @relation(fields: [cityId], references: [id])

  orders Order[] // ⭐ ADD THIS LINE

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReportLayout {
  id               Int      @id @default(autoincrement())
  title            String?
  headerImg        String?
  footerImg        String?
  frontPageLastImg String?
  lastPageImg      String?
  alignment        String   @default("CENTER")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model User {
  id               Int       @id @default(autoincrement())
  name             String
  email            String    @unique
  phone            String?
  city             String?
  password         String
  status           String    @default("active")
  isActive         Boolean   @default(true)
  role             String
  rights           Json
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // RELATIONS (unique, corrected)
  reviewedPrescriptions Prescription[] @relation("PrescriptionReviewedBy")
  createdPrescriptions  Prescription[] @relation("PrescriptionCreatedBy")

  createdBanners          Banner[]
  createdSpotlightBanners SpotlightBanner[]
  createdCategories       Category[]
  createdSubCategories    SubCategory[]
  createdTests            Test[]
  createdHealthPackages   HealthPackage[]
  createdCoupons          Coupon[]
  createdVendors          Vendor[]
  createdCenters          Center[]
  createdDoctors          Doctor[]
  createdSlots            Slot[]
  updatedEnquiries      Enquiry[] @relation("EnquiryUpdatedBy")
  createdNotifications  Notification[]
  createdTestParameters TestParameter[]
  collectionPrices      CollectionPrice[]

  // Payment relations FIXED
  createdPayments Payment[] @relation("PaymentCreatedBy")
  updatedPayments Payment[] @relation("PaymentUpdatedBy")

  // ANY OTHER DUPLICATES REMOVED
  patients                 Patient[]
  addresses                Address[]
  vendorProfiles           VendorProfile[]
  earningsHistories        EarningsHistory[]
  orders                   Order[]
  vendorOrderRejections    VendorOrderRejection[]
  paymentGateways          PaymentGateway[]
  paymentWebhookLogs       PaymentWebhookLog[]
  carts                    Cart[]
  cartItems                CartItem[]
  orderTrackings           OrderTracking[]
  orderSlots               OrderSlot[]
  referenceCenters         ReferenceCenter[]
  parameterRanges          ParameterRange[]
  resultOptions            ResultOption[]
  patientTestResults       PatientTestResult[]
  parameterResults         ParameterResult[]
  createdDiagnosticCenters DiagnosticCenter[]
}

model Patient {
  id       Int       @id @default(autoincrement())
  fullName String?
  initial  String?
  dob      DateTime?
  age      Int?
  gender   String?
  email    String?
  height   String?

  weight             String?
  smokingHabit       String?
  alcoholConsumption String?
  exerciseFrequency  String?
  bloodType          String?
  contactNo          String?   @unique
  status             String    @default("active")
  otp                String?
  otpExpiry          DateTime?

  relationship  String?
  isPrimary     Boolean   @default(false)
  primaryId     Int?
  aadharNo      String?
  address       String?
  passportNo    String?
  primary       Patient?  @relation("FamilyRelation", fields: [primaryId], references: [id])
  familyMembers Patient[] @relation("FamilyRelation")

  createdById Int? // ⭐ ADDED: Track who created the patient
  createdBy   User? @relation(fields: [createdById], references: [id])

  addresses Address[]
   enquiries Enquiry[]
  orders         Order[]
  couponUsages   CouponUsage[]
  prescriptions  Prescription[]
  cart           Cart[]
  cartItems      CartItem[]
  orderMembers   OrderMember[]
  VendorReview   VendorReview[]
  patientDevices PatientDevice[]
  testResults    PatientTestResult[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  NotificationLog NotificationLog[]
  payments        Payment[]
}

model PatientDevice {
  id        Int      @id @default(autoincrement())
  patientId Int
  fcmToken  String   @unique
  platform  String? // android / ios / web
  createdAt DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Address {
  id        Int     @id @default(autoincrement())
  saveas    String?
  landmark  String?
  city      String
  state     String
  pincode   String
  latitude  Float?
  longitude Float?
  address   String

  createdById Int? // ⭐ ADDED: Track who created the address
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])

  orders Order[]
}

model Category {
  id                 Int                  @id @default(autoincrement())
  imgUrl             String?
  name               String
  order              Int?
  type               String?
  bannerUrl          String?
  createdById        Int? // ⭐ ADDED: Track who created the category
  createdBy          User?                @relation(fields: [createdById], references: [id])
  isPopular          Boolean              @default(false)
  subCategories      SubCategory[]
  tests              Test[]
  packages           HealthPackage[]
  centers            CenterCategory[]
  ESignatureCategory ESignatureCategory[]
  // ✅ NEW
  centerSlots CenterSlot[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubCategory {
  id     Int     @id @default(autoincrement())
  catId  Int
  imgUrl String?
  order  Int?
  name   String

  createdById Int? // ⭐ ADDED: Track who created the subcategory
  createdBy   User? @relation(fields: [createdById], references: [id])

  category Category @relation(fields: [catId], references: [id])
  tests    Test[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ShowIn {
  HOME
  TEST
  OFFER
}

model HealthPackage {
  id            Int     @id @default(autoincrement())
  name          String
  description   String?
  imgUrl        String?
  alsoKnowAs    String?
  actualPrice   Float
  offerPrice    Float?
  reportWithin  Int?
  reportUnit    String  @default("hours")
  status        String  @default("active")
  categoryId    Int?
  noOfParameter String?
  testType      String? @default("PATHOLOGY")
  discount      Float   @default(0)
  showIn        ShowIn? @default(TEST)
  spotlight     Boolean @default(false)
  features      String?
  preparations   String?
  sampleRequired String?
  createdById   Int? // ⭐ ADDED: Track who created the package
  createdBy     User?   @relation(fields: [createdById], references: [id])

  category            Category?            @relation(fields: [categoryId], references: [id])
  checkupPackages     CheckupPackage[]
  cartItems           CartItem[]
  OrderCheckup        OrderCheckup[]
  orderMemberPackages OrderMemberPackage[]
  banners             Banner[]
  spotlightBanners    SpotlightBanner[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Checkup")
}

model Test {
  id             Int     @id @default(autoincrement())
  name           String
  actualPrice    Float
  offerPrice     Float?
  discount       Float   @default(0)
  cityWisePrice  Json?
  gender         String?
  imgUrl         String?
  description    String?
  contains       String?
  alsoKnowAs     String?
  preparations   String?
  sampleRequired String?
  features       String?

  testType      String
  categoryId    Int
  subCategoryId Int?
  showIn        String?
  noOfParameter String?
  spotlight     Boolean @default(false)
  reportWithin  Int
  reportUnit    String  @default("hours")
  status        String  @default("active")

  createdById Int? // ⭐ ADDED: Track who created the test
  createdBy   User? @relation(fields: [createdById], references: [id])

  category    Category     @relation(fields: [categoryId], references: [id])
  subCategory SubCategory? @relation(fields: [subCategoryId], references: [id])

  centerPackages      CenterPackage[]      @relation("TestToCenterPackage")
  checkupPackages     CheckupPackage[]
  cartItems           CartItem[]
  prescriptions       Prescription[]
  parameters          TestParameter[]
  patientResults      PatientTestResult[]
  orderMemberPackages OrderMemberPackage[]
  banners             Banner[]
  spotlightBanners    SpotlightBanner[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Package")
}

model CheckupPackage {
  id        Int @id @default(autoincrement())
  checkupId Int
  testId    Int

  checkup HealthPackage @relation(fields: [checkupId], references: [id])
  test    Test          @relation(fields: [testId], references: [id])

  @@map("CheckupPackage")
}

model Coupon {
  id              Int       @id @default(autoincrement())
  code            String    @unique
  description     String?
  discountType    String    @default("percentage") // "percentage" or "fixed"
  discountValue   Float
  minOrderAmount  Float?
  maxDiscount     Float?
  validFrom       DateTime? // renamed from startDate
  validUntil      DateTime? // renamed from expiryDate
  usageLimit      Int?
  perUserLimit    Int?
  usedCount       Int?      @default(0) // ADDED: Track usage count
  isActive        Boolean   @default(true)
  autoApply       Boolean   @default(false)
  isPatientCoupon Boolean   @default(false) // ADDED: Patient-specific coupon
  patientId       Int? // ADDED: If coupon is for specific patient

  createdById Int? // Track who created the coupon
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  orders       Order[]       @relation("OrderCouponRelation")
  couponUsages CouponUsage[]
}

model CouponUsage {
  id        Int  @id @default(autoincrement())
  couponId  Int
  patientId Int // ✅ correct relation (not userId)
  orderId   Int?

  usedAt DateTime @default(now())

  coupon  Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([couponId, patientId, orderId])
}

model Vendor {
  id       Int       @id @default(autoincrement())
  name     String
  number   String    @unique
  city     String?
  category String?
  gender   String?
  dob      DateTime?
  age      Int?
  pincode  Int?
  radius   Int?
  earnings Float     @default(0)
  address  String?
  email    String?   @unique
  password String
  status   String    @default("inactive")
  block    Boolean   @default(false)

  createdById Int? // ⭐ ADDED: Track who created the vendor
  createdBy   User? @relation(fields: [createdById], references: [id])

  isOnline        Boolean           @default(false)
  otp             String?
  otpExpiry       DateTime?
  overallRating   Float             @default(0)
  totalReviews    Int               @default(0)
  profile         VendorProfile?
  orders          Order[]
  history         EarningsHistory[]
  locationHistory VendorLocation[]
  reviews         VendorReview[]
  payments        Payment[]
  devices         VendorDevice[]
   attendance VendorAttendance[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model VendorReview {
  id        Int      @id @default(autoincrement())
  vendorId  Int
  patientId Int?
  rating    Int // 1–5 stars
  comment   String?
  createdAt DateTime @default(now())

  vendor  Vendor   @relation(fields: [vendorId], references: [id])
  patient Patient? @relation(fields: [patientId], references: [id])
}

model VendorProfile {
  id             Int     @id @default(autoincrement())
  vendorId       Int     @unique
  photoUrl       String?
  clinicName     String?
  specialization String?
  experience     Int?
  qualification  String?
  bio            String?

  createdById Int? // ⭐ ADDED: Track who created the profile
  createdBy   User? @relation(fields: [createdById], references: [id])

  vendor Vendor @relation(fields: [vendorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EarningsHistory {
  id           Int     @id @default(autoincrement())
  vendorId     Int
  title        String
  desc         String?
  amount       Float
  type         String // 'add', 'deduct', 'order_earning'
  balanceAfter Float

  createdById Int? // ⭐ ADDED: Track who created the earnings history
  createdBy   User? @relation(fields: [createdById], references: [id])

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorId])
  @@index([createdAt])
}

model Center {
  id               Int     @id @default(autoincrement())
  name             String
  address          String?
  pincode          String?
  contactName      String?
  email            String? @unique
  alternativeEmail String?
  mobile           String?
  lat              Float?
  long             Float?
  isSelf           Boolean @default(false)
  status           String  @default("active")

  cityId Int?
  city   City? @relation(fields: [cityId], references: [id])

  centerPackages CenterPackage[] @relation("CenterToCenterPackage")

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  orders           Order[]
  payments         Payment[]
  centerSlots      CenterSlot[]
  categories       CenterCategory[]
  collectionPrices CollectionPrice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cityId]) // ✅
}

model CenterSlot {
  id       Int @id @default(autoincrement())
  centerId Int

  // ✅ NEW: category-wise slot
  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  name      String?
  startTime String
  endTime   String
  capacity  Int     @default(0)
  isActive  Boolean @default(true)

  center   Center              @relation(fields: [centerId], references: [id], onDelete: Cascade)
  orders   Order[]
  bookings CenterSlotBooking[]

  @@index([centerId])
  @@index([categoryId])

  // ✅ optional but recommended: avoid duplicates
  @@unique([centerId, categoryId, name])
}


model CenterCategory {
  id         Int @id @default(autoincrement())
  centerId   Int
  categoryId Int

  center   Center   @relation(fields: [centerId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([centerId, categoryId])
}

model CenterSlotBooking {
  id     Int      @id @default(autoincrement())
  slotId Int
  date   DateTime
  count  Int      @default(0)

  slot CenterSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@unique([slotId, date]) // one record per slot per date
}

model CenterPackage {
  id       Int @id @default(autoincrement())
  centerId Int
  testId   Int

  center Center @relation("CenterToCenterPackage", fields: [centerId], references: [id], onDelete: Cascade)
  test   Test   @relation("TestToCenterPackage", fields: [testId], references: [id], onDelete: Cascade)

  @@unique([centerId, testId])
  @@map("CenterPackage")
}

model Order {
  id              Int     @id @default(autoincrement())
  orderNumber     String  @unique
  merchantOrderId String? @unique

  centerId           Int? // ⭐ where sample is collected
  refCenterId        Int? // ⭐ which doctor/hospital referred the patient
  vendorId           Int?
  diagnosticCenterId Int?
  doctorId           Int?
  patientId          Int
  addressId          Int?
  source             String?

  isSelf          Boolean     @default(false)
  totalAmount     Float
  discount        Float?
  finalAmount     Float?
  paymentStatus   String?     @default("pending")
  paymentMode     String?
  status          String      @default("pending")
  testType        String?
  // slot            String?
  date            DateTime
  documentImage   String?
  orderType       String?
  remarks         String?
  assignmentNotes String?
  trackingId      String?
  reportUrl       String?
  sampleCollected Boolean     @default(false)
  reportReady     Boolean     @default(false)
  isHomeSample    Boolean     @default(false)
  cancelledBy     String?
  cancelledAt     DateTime?
  couponId        Int?
  couponCode      String?
  discountAmount  Float?
  slotId          Int?
  slot            Slot?       @relation(fields: [slotId], references: [id])
  // ✅ ADD THIS
  centerSlotId    Int?
  centerSlot      CenterSlot? @relation(fields: [centerSlotId], references: [id])
  createdById     Int?
  createdBy       User?       @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  center    Center?          @relation(fields: [centerId], references: [id])
  refCenter ReferenceCenter? @relation(fields: [refCenterId], references: [id])
  vendor    Vendor?          @relation(fields: [vendorId], references: [id])
  patient   Patient          @relation(fields: [patientId], references: [id])
  address   Address?         @relation(fields: [addressId], references: [id], onDelete: Cascade)
  doctor    Doctor?          @relation(fields: [doctorId], references: [id])
  coupon    Coupon?          @relation("OrderCouponRelation", fields: [couponId], references: [id])

  diagnosticCenter DiagnosticCenter? @relation(fields: [diagnosticCenterId], references: [id])

  orderCheckups OrderCheckup[]
  orderTracking OrderTracking?
  orderMembers  OrderMember[]
  payments      Payment[]
  couponUsages  CouponUsage[]
   patientTestResults PatientTestResult[]

}

model Doctor {
  id             Int     @id @default(autoincrement())
  initial        String? // Dr., Mr., Mrs.
  name           String
  qualification  String?
  specialityType String?
  speciality     String?
  mobile         String? @unique
  landLine       String?
  email          String? @unique
  venue          String?
  refCenter      String?
  source         String?
  address        String?
  otherInfo      String?
  patientId      Int?

  sendSms          Boolean @default(false)
  sendEmail        Boolean @default(false)
  consultingDoctor Boolean @default(false)

  number String @unique

  createdById Int? // ⭐ ADDED: Track who created the doctor
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

model ESignature {
  id            Int       @id @default(autoincrement())
  name          String
  qualification String?
  designation   String?
  signatureImg  String
  alignment     Alignment @default(LEFT)

  patientTestResultsLeft   PatientTestResult[] @relation("PTR_LeftSig")
  patientTestResultsCenter PatientTestResult[] @relation("PTR_CenterSig")
  patientTestResultsRight  PatientTestResult[] @relation("PTR_RightSig")

  // ✅ categories via relation table
  categories ESignatureCategory[]
}

model ESignatureCategory {
  id Int @id @default(autoincrement())

  signatureId Int
  signature   ESignature @relation(fields: [signatureId], references: [id], onDelete: Cascade)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // ✅ default per category
  isDefault Boolean @default(false)

  @@unique([signatureId, categoryId])
  
  @@index([categoryId])
  @@index([signatureId])
  @@index([isDefault])
}

model OrderMember {
  id        Int @id @default(autoincrement())
  orderId   Int
  patientId Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id])

  orderMemberPackages OrderMemberPackage[]
}

enum ReportDispatchStatus {
  NOT_READY
  READY
  DISPATCHED
  DELIVERED
}

model OrderMemberPackage {
  id Int @id @default(autoincrement())

  orderMemberId Int
  orderMember   OrderMember @relation(fields: [orderMemberId], references: [id], onDelete: Cascade)

  packageId Int?
  package   HealthPackage? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  testId Int?
  test   Test? @relation(fields: [testId], references: [id], onDelete: SetNull)

  // ✅ SLA snapshot (per patient + test/package)
  reportWithin Int?
  reportUnit   String?
  reportDueAt  DateTime?

  // ✅ dispatch tracking
  dispatchStatus  ReportDispatchStatus @default(NOT_READY)
  readyAt         DateTime?
  dispatchedAt    DateTime?
 


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderMemberId])
  @@index([packageId])
  @@index([testId])
  @@index([dispatchStatus])
  @@index([reportDueAt])
  @@map("OrderMemberPackage")
}

model VendorOrderRejection {
  id       Int     @id @default(autoincrement())
  vendorId Int
  orderId  Int
  reason   String?

  createdById Int? // ⭐ ADDED: Track who created the rejection
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderCheckup {
  id        Int      @id @default(autoincrement())
  orderId   Int
  checkupId Int
  createdAt DateTime @default(now())

  order   Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  checkup HealthPackage @relation(fields: [checkupId], references: [id])

  @@unique([orderId, checkupId])
  @@map("OrderCheckup")
}

model Prescription {
  id           Int                  @id @default(autoincrement())
  patientId    Int
  reviewedById Int?
  fileUrl      String
  fileType     PrescriptionFileType
  status       PrescriptionStatus   @default(PENDING_REVIEW)
  remarks      String?
  uploadedAt   DateTime             @default(now())
  reviewedAt   DateTime?

  createdById Int?
  createdBy   User? @relation("PrescriptionCreatedBy", fields: [createdById], references: [id])

  reviewedBy User? @relation("PrescriptionReviewedBy", fields: [reviewedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  testId Int?
  test   Test? @relation(fields: [testId], references: [id])

  @@map("Prescription")
}

// ⭐ UPDATED: Enhanced Payment Model
model Payment {
  id              Int           @id @default(autoincrement())
  orderId         Int?
  patientId       Int?
  userId          Int?
  centerId        Int?
  vendorId        Int?
  paymentId       String        @unique
  paymentMethod   PaymentMethod
  paymentMode     PaymentMode?
  paymentStatus   PaymentStatus @default(PENDING)
  amount          Float
  currency        String        @default("INR")
  paymentDate     DateTime      @default(now())
  transactionNote String?
  referenceId     String?
  invoiceUrl      String?
  gatewayResponse Json?
  capturedAmount  Float?

  // Refund fields
  refundAmount    Float?
  refundDate      DateTime?
  refundReason    String?
  refundReference String?

  // Audit fields
  createdById Int?
  createdBy   User? @relation("PaymentCreatedBy", fields: [createdById], references: [id])

  updatedById Int?
  updatedBy   User? @relation("PaymentUpdatedBy", fields: [updatedById], references: [id])

  ipAddress String?

  // Relations
  order   Order?   @relation(fields: [orderId], references: [id])
  patient Patient? @relation(fields: [patientId], references: [id])
  vendor  Vendor?  @relation(fields: [vendorId], references: [id])
  center  Center?  @relation(fields: [centerId], references: [id])

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  paymentGateway     PaymentGateway?     @relation(fields: [paymentGatewayId], references: [id])
  paymentGatewayId   Int?
  paymentWebhookLogs PaymentWebhookLog[]

  @@index([orderId])
  @@index([patientId])
  @@index([vendorId])
  @@index([centerId])
  @@index([paymentStatus])
  @@index([paymentDate])
  @@index([referenceId])
  @@index([createdById])
}

// ⭐ NEW: Payment Gateway Model
model PaymentGateway {
  id         Int     @id @default(autoincrement())
  name       String  @unique
  gatewayKey String
  secretKey  String
  webhookUrl String?
  isActive   Boolean @default(true)
  config     Json?

  createdById Int? // ⭐ ADDED: Track who created the gateway
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments           Payment[]
  paymentWebhookLogs PaymentWebhookLog[]
}

// ⭐ NEW: Payment Webhook Logs
model PaymentWebhookLog {
  id        Int     @id @default(autoincrement())
  paymentId Int?
  gatewayId Int?
  event     String
  payload   Json
  status    String  @default("RECEIVED")
  error     String?

  createdById Int? // ⭐ ADDED: Track who processed the webhook
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  payment Payment?        @relation(fields: [paymentId], references: [id])
  gateway PaymentGateway? @relation(fields: [gatewayId], references: [id])
}

model Notification {
  id               Int    @id @default(autoincrement())
  title            String
  message          String
  type             String // push, whatsapp, both, email, sms
  audience         String // all, selected_patients, segment
  selectedPatients Json? // JSON array of patient IDs for selected_patients audience
  segmentCriteria  Json? // JSON object for segment-based audience
  status           String @default("draft") // draft, scheduled, sending, sent, partial, failed, cancelled

  // Timing fields
  scheduledAt DateTime?
  sentAt      DateTime?

  // Content fields
  imageUrl String?
  deepLink String?
  priority String  @default("normal") // low, normal, high
  category String? // promotional, transactional, alert, etc.

  // Stats fields
  recipients   Int @default(0)
  openCount    Int @default(0)
  clickCount   Int @default(0)
  failureCount Int @default(0)

  // Resend tracking
  originalNotificationId Int? // For tracking resend history
  isResend               Boolean @default(false)
  resendCount            Int     @default(0)

  // Creator tracking
  createdById Int? // User ID who created the notification
  createdBy   User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  logs NotificationLog[]

  // Indexes for better query performance
  @@index([status])
  @@index([scheduledAt])
  @@index([sentAt])
  @@index([createdById])
  @@index([type])
  @@index([audience])
  @@map("notifications")
}

model NotificationLog {
  id             Int          @id @default(autoincrement())
  notificationId Int
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  patientId      Int
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  type           String // push, whatsapp, etc.
  status         String // sent, failed, opened, clicked
  deviceToken    String?
  phoneNumber    String?
  email          String?
  errorMessage   String?
  openedAt       DateTime?
  clickedAt      DateTime?
  isResend       Boolean      @default(false)
  sentAt         DateTime     @default(now())

  @@index([notificationId])
  @@index([patientId])
  @@index([status])
  @@index([sentAt])
  @@index([type])
  @@map("notification_logs")
}

model Cart {
  id          Int    @id @default(autoincrement())
  patientId   Int
  subtotal    Float  @default(0)
  discount    Float  @default(0)
  finalAmount Float  @default(0)
  status      String @default("active")

  createdById Int? // ⭐ ADDED: Track who created/updated the cart
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient   Patient    @relation(fields: [patientId], references: [id])
  cartItems CartItem[]
}

model CartItem {
  id         Int   @id @default(autoincrement())
  cartId     Int
  patientId  Int
  offerPrice Float
  testId     Int?
  packageId  Int?

  isSelected Boolean @default(true)

  createdById Int? // ⭐ ADDED: Track who added the cart item
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  test    Test?          @relation(fields: [testId], references: [id])
  package HealthPackage? @relation(fields: [packageId], references: [id])
  patient Patient        @relation(fields: [patientId], references: [id])

  @@map("CartItem")
}

model OrderTracking {
  id              Int       @id @default(autoincrement())
  orderId         Int       @unique
  vendorId        Int?
  userLatitude    Float
  userLongitude   Float
  vendorLatitude  Float?
  vendorLongitude Float?
  vendorPath      Json?
  isActive        Boolean   @default(true)
  startTime       DateTime  @default(now())
  endTime         DateTime?
  lastEtaUpdate   DateTime  @default(now())
    // ✅ ADD THIS (NEW)
  lastMetrics     Json?
  createdById     Int? // ⭐ ADDED: Track who created the tracking
  createdBy       User?     @relation(fields: [createdById], references: [id])

  order Order @relation(fields: [orderId], references: [id])

  @@map("order_tracking")
}

model VendorLocation {
  id        Int      @id @default(autoincrement())
  vendorId  Int
  orderId   Int?
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id])

  @@index([vendorId])
  @@index([orderId])
  @@index([createdAt])
  @@map("vendor_location")
}

model Slot {
  id   Int     @id @default(autoincrement())
  name String?

  startTime DateTime?
  endTime   DateTime?

  capacity Int
  isActive Boolean @default(true)

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orders     Order[]
  orderSlots OrderSlot[]
}

model OrderSlot {
  id     Int      @id @default(autoincrement())
  slotId Int
  date   DateTime // date for bookings (no time)
  count  Int      @default(0)

  createdById Int? // ⭐ ADDED: Track who booked the slot
  createdBy   User? @relation(fields: [createdById], references: [id])

  slot Slot @relation(fields: [slotId], references: [id])
}

model ReferenceCenter {
  id                    Int     @id @default(autoincrement())
  name                  String
  contactName           String?
  address               String?
  email                 String?
  mobile                String?
  city                  String?
  state                 String?
  lat                   Float?
  long                  Float?
  billType              String?
  paymentType           String?
  emailReportConfig     String?
  sendReportMail        Boolean @default(false)
  sendBillMailToPatient Boolean @default(false)

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  orders Order[] // ⭐ referenced only in orders

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TestParameter {
  id          Int     @id @default(autoincrement())
  testId      Int
  name        String
  type        String?
  order       Int?
  unit        String?
  method      String?
  notes       String?
  isActive    Boolean @default(true)
  options     Json?
  createdById Int? // ⭐ ADDED: Track who created the parameter
  createdBy   User?   @relation(fields: [createdById], references: [id])

  test       Test              @relation(fields: [testId], references: [id], onDelete: Cascade)
  ranges     ParameterRange[]
  resultOpts ResultOption[]
  results    ParameterResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ParameterRange {
  id                   Int     @id @default(autoincrement())
  parameterId          Int
  lowerLimit           Float?
  upperLimit           Float?
  criticalLow          Float?
  criticalHigh         Float?
  referenceRange       String?
  gender               String?
  normalValueHtml      String?
  specialConditionHtml String?

  createdById Int? // ⭐ ADDED: Track who created the range
  createdBy   User? @relation(fields: [createdById], references: [id])

  parameter TestParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResultOption {
  id          Int     @id @default(autoincrement())
  parameterId Int
  label       String
  value       String?

  createdById Int? // ⭐ ADDED: Track who created the option
  createdBy   User? @relation(fields: [createdById], references: [id])

  parameter TestParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PatientTestResult {
  id           Int              @id @default(autoincrement())
  patientId    Int
  testId       Int
  orderId      Int?
  collectedAt  DateTime?
  reportedAt   DateTime?
  reportedById Int?
  status       TestResultStatus @default(DRAFT)
  notes        String?
  rawJson      Json?

  reportHtml String? // ⭐ REQUIRED for radiology reports

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

    // ✅ Manual override signatures for THIS patient+test report (optional)
  leftSignatureId   Int?
  centerSignatureId Int?
  rightSignatureId  Int?
    leftSignature   ESignature? @relation("PTR_LeftSig", fields: [leftSignatureId], references: [id], onDelete: SetNull)
  centerSignature ESignature? @relation("PTR_CenterSig", fields: [centerSignatureId], references: [id], onDelete: SetNull)
  rightSignature  ESignature? @relation("PTR_RightSig", fields: [rightSignatureId], references: [id], onDelete: SetNull)
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  test             Test              @relation(fields: [testId], references: [id])
  parameterResults ParameterResult[]

    @@index([orderId])
}

model ParameterResult {
  id                  Int     @id @default(autoincrement())
  patientTestResultId Int
  parameterId         Int
  valueText           String?
  valueNumber         Float?
  unit                String?
  flag                String?
  normalRangeText     String?

  createdById Int? // ⭐ ADDED: Track who entered the result
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientTestResult PatientTestResult @relation(fields: [patientTestResultId], references: [id], onDelete: Cascade)
  parameter         TestParameter     @relation(fields: [parameterId], references: [id])
}

model VendorEarningConfig {
  id                Int   @id @default(autoincrement())
  baseAmount        Float
  perKmRate         Float
  thresholdDistance Float @default(0)
  bonusForFiveStar  Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PatientReportPdf {
  id        Int @id @default(autoincrement())
  orderId   Int
  patientId Int

  plainPdfUrl      String?
  letterheadPdfUrl String?
  fullPdfUrl       String?

  plainPdfKey      String?
  letterheadPdfKey String?
  fullPdfKey       String?

  status      String    @default("NOT_GENERATED") // NOT_GENERATED|PENDING|READY|FAILED
  generatedAt DateTime?
  version     Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, patientId])
  @@index([orderId])
  @@index([patientId])
}

model VendorDevice {
  id        Int      @id @default(autoincrement())
  vendorId  Int
  fcmToken  String   @unique
  platform  String? // android / ios / web
  createdAt DateTime @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
}


enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
}

model VendorAttendance {
  id Int @id @default(autoincrement())

  vendorId Int
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  // ✅ date-only (one row per vendor per day)
  day DateTime @db.Date

  status AttendanceStatus @default(PRESENT)

  // ✅ check-in only
  checkInAt DateTime?
  selfieUrl String?
  selfieKey String? // ✅ store S3 key (needed to delete later)

  lat Float?
  lng Float?

  // track deletion action (optional but helpful)
  selfieDeletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vendorId, day])
  @@index([day])
  @@index([vendorId])
}


model Enquiry {
  id       Int    @id @default(autoincrement())
  name     String?
  number   String

  status   String @default("NEW")

  // ✅ who created enquiry (patient from app token)
  patientId Int?
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  // ✅ who last updated in admin panel
  updatedById Int?
  updatedBy   User? @relation("EnquiryUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([number])
  @@index([status])
  @@index([updatedById])
}
